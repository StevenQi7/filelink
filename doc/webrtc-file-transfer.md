# WebRTC 点对点文件传输实现文档

## 1. 系统概述

本系统基于 WebRTC 技术实现了浏览器端的点对点文件传输功能，无需通过服务器中转，文件数据直接在两端之间传输，保证传输速度和隐私安全。系统采用信令服务器辅助建立连接，支持多文件选择、传输进度显示、传输确认等功能。

## 2. 连接建立流程

### 2.1 角色划分

系统中包含两种角色：
- **发送方(Sender)**: 选择并发送文件的一方
- **接收方(Receiver)**: 接收文件的一方

### 2.2 详细步骤

#### 发送方流程

1. **选择文件**
   - 发送方先选择要传输的文件
   - 系统生成文件元信息(文件名、大小、类型、ID)

2. **创建会话**
   - 系统生成6位数字房间密码(Room Code)
   - 向信令服务器发送创建会话请求，包含设备信息
   - 服务器返回唯一会话ID(Session ID)

3. **建立WebSocket连接**
   - 连接到信令服务器
   - 发送会话ID和设备ID
   - 等待接收方加入

4. **等待接收方加入**
   - 接收方通过房间密码加入后，发送方收到"joined"事件
   - 发送方初始化WebRTC连接

5. **创建SDP Offer**
   - 创建RTC连接和数据通道
   - 生成SDP Offer
   - 通过WebSocket发送给接收方

6. **处理ICE候选**
   - 收集并通过WebSocket发送ICE候选给接收方

7. **接收Answer**
   - 接收方返回SDP Answer
   - 设置远程描述(Remote Description)

8. **发送文件信息**
   - 连接建立后，发送文件元信息给接收方
   - 等待接收方确认接收

9. **传输文件**
   - 接收方确认后，开始分块传输文件
   - 实时显示传输进度

#### 接收方流程

1. **加入会话**
   - 输入6位房间密码
   - 向信令服务器发送加入请求
   - 加入成功后获取会话ID

2. **建立WebSocket连接**
   - 连接到信令服务器
   - 发送会话ID和设备ID

3. **发送连接请求**
   - 主动发送连接请求给发送方
   - 请求发送方初始化WebRTC连接

4. **接收SDP Offer**
   - 接收发送方的SDP Offer
   - 初始化WebRTC连接
   - 设置远程描述(Remote Description)

5. **创建SDP Answer**
   - 创建SDP Answer
   - 通过WebSocket发送给发送方

6. **处理ICE候选**
   - 接收发送方的ICE候选并添加到连接
   - 收集并发送自己的ICE候选给发送方

7. **接收文件信息**
   - 连接建立后，接收发送方的文件信息
   - 显示文件确认对话框

8. **确认接收文件**
   - 用户确认是否接收文件
   - 发送确认信息给发送方

9. **接收文件数据**
   - 接收文件数据块并保存
   - 实时显示接收进度
   - 完成后提供下载按钮

## 3. 通信协议

### 3.1 WebSocket事件

| 事件名 | 发送方 | 接收方 | 说明 |
|-------|-------|-------|------|
| connection_status | 服务器 | 客户端 | 连接状态信息 |
| peer | 服务器 | 客户端 | 对等端动作通知(如加入、离开) |
| offer | 发送方 | 接收方 | SDP连接提议 |
| answer | 接收方 | 发送方 | SDP应答 |
| ice_candidate | 双方 | 对方 | ICE连接候选地址 |
| request_connection | 任何一方 | 对方 | 请求建立连接 |
| files_info | 发送方 | 接收方 | 文件元信息 |
| request_files_info | 接收方 | 发送方 | 请求文件信息 |

### 3.2 数据通道消息类型

| 消息类型 | 发送方 | 接收方 | 说明 |
|---------|-------|-------|------|
| files_info | 发送方 | 接收方 | 文件元信息 |
| file-confirm | 接收方 | 发送方 | 确认是否接收文件 |
| file-start | 发送方 | 接收方 | 开始发送某个文件 |
| file-end | 发送方 | 接收方 | 文件发送完成 |
| request_files_info | 接收方 | 发送方 | 请求文件信息 |

## 4. 文件传输机制

1. **分块传输**
   - 文件以16KB为单位分块传输
   - 每个块作为二进制数据(ArrayBuffer)传输

2. **进度跟踪**
   - 发送方实时计算并显示发送进度
   - 接收方实时计算并显示接收进度

3. **文件完成处理**
   - 接收完成后，将所有块合并为完整文件
   - 提供下载按钮，将文件保存到本地

## 5. 错误处理和恢复机制

1. **连接失败重试**
   - 如连接建立失败，最多自动重试3次
   - 通过localStorage记录重试状态

2. **WebSocket断线重连**
   - WebSocket断开后自动尝试重连
   - 重连成功后恢复之前的Offer/Answer交换

3. **文件传输中断恢复**
   - 设计支持断点续传(当前版本未完全实现)

4. **手动重新连接**
   - 提供重新发送连接请求的接口
   - 提供请求文件信息的接口

## 6. 实现注意事项

1. **设备和会话标识**
   - 设备ID在首次访问时生成并存储在localStorage
   - 会话ID由服务器生成并在会话期间保持不变

2. **状态持久化**
   - 关键状态存储在localStorage，防止页面刷新丢失

3. **连接状态管理**
   - 使用React ref存储WebRTC连接对象，避免状态更新问题
   - WebSocket连接保持单例，避免重复连接

4. **调试支持**
   - 系统内置详细日志记录
   - 提供连接状态实时显示

## 7. 接入步骤

### 7.1 服务端接入

1. 实现会话管理API:
   - `/api/session/create` - 创建新会话
   - `/api/session/join` - 加入已有会话

2. 实现WebSocket信令服务，支持如下事件:
   - connection_status
   - peer
   - offer/answer
   - ice_candidate
   - request_connection
   - files_info

### 7.2 客户端接入

1. 初始化:
   - 生成设备ID
   - 初始化WebRTC配置

2. 实现角色选择:
   - 发送方选择文件并创建会话
   - 接收方输入房间密码加入会话

3. 实现WebRTC事件处理:
   - ICE候选收集与交换
   - SDP offer/answer交换
   - 数据通道创建与管理

4. 实现文件处理:
   - 文件选择与元信息生成
   - 文件分块传输
   - 文件接收与合并

5. 实现用户界面:
   - 连接状态显示
   - 文件确认对话框
   - 传输进度显示

通过遵循以上步骤，开发者可以轻松地将本WebRTC点对点文件传输功能集成到自己的应用中。 